<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PsychoGraph â€” Both Sides Analysis</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap');

  :root {
    --bg: #0e0f11;
    --surface: #16181c;
    --surface2: #1e2128;
    --border: #2a2d35;
    --accent: #c8f04f;
    --accent2: #f04f8a;
    --accent3: #4fc8f0;
    --text: #e8eaf0;
    --muted: #6b7280;
    --warn: #f0a44f;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    min-height: 100vh;
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    border-bottom: 1px solid var(--border);
    padding: 24px 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    letter-spacing: -0.5px;
    color: var(--accent);
  }
  .logo span { color: var(--text); }

  .header-meta {
    color: var(--muted);
    font-size: 11px;
  }

  /* â”€â”€ Layout â”€â”€ */
  .app { display: flex; height: calc(100vh - 65px); }

  /* Sidebar */
  .sidebar {
    width: 240px;
    border-right: 1px solid var(--border);
    background: var(--surface);
    overflow-y: auto;
    flex-shrink: 0;
  }

  .sidebar-section {
    padding: 16px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-label {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 10px;
  }

  .participant-btn {
    display: block;
    width: 100%;
    text-align: left;
    padding: 10px 12px;
    border-radius: 6px;
    border: 1px solid transparent;
    background: none;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
    margin-bottom: 4px;
  }

  .participant-btn:hover { background: var(--surface2); border-color: var(--border); }
  .participant-btn.active { background: var(--surface2); border-color: var(--accent); color: var(--accent); }

  .participant-btn .msg-count {
    float: right;
    font-size: 10px;
    color: var(--muted);
  }

  /* Main content */
  .main {
    flex: 1;
    overflow-y: auto;
    padding: 32px 40px;
  }

  /* Upload zone */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 60px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 32px;
  }

  .upload-zone:hover { border-color: var(--accent); background: rgba(200,240,79,0.03); }
  .upload-zone.dragover { border-color: var(--accent); background: rgba(200,240,79,0.06); }

  .upload-icon { font-size: 36px; margin-bottom: 12px; }
  .upload-title { font-family: 'DM Serif Display', serif; font-size: 18px; margin-bottom: 8px; }
  .upload-sub { color: var(--muted); font-size: 11px; line-height: 1.6; }

  .btn {
    display: inline-block;
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.15s;
  }

  .btn-primary { background: var(--accent); color: #0e0f11; }
  .btn-primary:hover { background: #d4f566; }
  .btn-demo { background: var(--surface2); color: var(--text); border: 1px solid var(--border); margin-left: 10px; }
  .btn-demo:hover { border-color: var(--accent3); color: var(--accent3); }

  /* Patient header */
  .patient-header {
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .patient-name {
    font-family: 'DM Serif Display', serif;
    font-size: 28px;
    margin-bottom: 4px;
  }

  .patient-sub { color: var(--muted); }

  /* Section titles */
  .section-title {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 16px;
    margin-top: 32px;
  }

  /* TWO COLUMN LAYOUT for side-by-side comparison */
  .two-column {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 32px;
  }

  .column-header {
    font-family: 'DM Serif Display', serif;
    font-size: 18px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid;
  }

  .column-header.patient { border-color: var(--accent); color: var(--accent); }
  .column-header.other { border-color: var(--accent3); color: var(--accent3); }

  /* KPI Grid */
  .kpi-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin-bottom: 8px;
  }

  .kpi-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    transition: border-color 0.15s;
  }

  .kpi-card:hover { border-color: var(--accent3); }

  .kpi-name {
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .kpi-score {
    font-family: 'DM Serif Display', serif;
    font-size: 32px;
    line-height: 1;
    margin-bottom: 8px;
  }

  .kpi-bar {
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .kpi-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .kpi-rationale { color: var(--muted); font-size: 11px; line-height: 1.5; }

  /* Defense Mechanism Grid */
  .defense-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .defense-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    display: flex;
    gap: 12px;
    align-items: flex-start;
  }

  .defense-card.active { border-color: var(--accent2); }

  .defense-count {
    font-family: 'DM Serif Display', serif;
    font-size: 28px;
    color: var(--muted);
    line-height: 1;
    flex-shrink: 0;
    width: 36px;
    text-align: center;
  }

  .defense-card.active .defense-count { color: var(--accent2); }

  .defense-info { flex: 1; }

  .defense-name {
    font-size: 11px;
    text-transform: capitalize;
    margin-bottom: 4px;
    font-weight: 500;
  }

  .defense-example {
    font-size: 10px;
    color: var(--muted);
    line-height: 1.5;
    font-style: italic;
  }

  /* Tag lists */
  .tag-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }

  .tag {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 11px;
    border: 1px solid;
  }

  .tag-green { background: rgba(200,240,79,0.08); border-color: var(--accent); color: var(--accent); }
  .tag-red { background: rgba(240,79,138,0.08); border-color: var(--accent2); color: var(--accent2); }
  .tag-blue { background: rgba(79,200,240,0.08); border-color: var(--accent3); color: var(--accent3); }
  .tag-warn { background: rgba(240,164,79,0.08); border-color: var(--warn); color: var(--warn); }

  /* Clinical notes */
  .clinical-notes {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent3);
    border-radius: 0 10px 10px 0;
    padding: 20px;
    font-size: 13px;
    line-height: 1.7;
    color: var(--text);
    margin-bottom: 16px;
  }

  /* Health score */
  .health-score-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 24px;
  }

  .health-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'DM Serif Display', serif;
    font-size: 28px;
    flex-shrink: 0;
    border: 3px solid;
  }

  .health-info h3 {
    font-family: 'DM Serif Display', serif;
    font-size: 18px;
    margin-bottom: 4px;
  }

  .health-info p { color: var(--muted); font-size: 12px; line-height: 1.5; }

  /* Flag */
  .flag-banner {
    background: rgba(240, 164, 79, 0.08);
    border: 1px solid var(--warn);
    border-radius: 8px;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    font-size: 12px;
    color: var(--warn);
  }

  /* Dynamic pill */
  .dynamic-pill {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 20px;
    background: rgba(79,200,240,0.1);
    border: 1px solid var(--accent3);
    color: var(--accent3);
    font-size: 12px;
    margin-bottom: 16px;
  }

  /* Interaction box */
  .interaction-box {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
  }

  .interaction-box h4 {
    font-size: 11px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--accent3);
    margin-bottom: 12px;
  }

  .interaction-box p {
    font-size: 12px;
    line-height: 1.6;
    color: var(--text);
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 80px 40px;
    color: var(--muted);
  }

  .empty-state .big { font-family: 'DM Serif Display', serif; font-size: 20px; color: var(--text); margin-bottom: 8px; }

  .loader { animation: pulse 1.5s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .fade-in { animation: fadeIn 0.4s ease forwards; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* DSM-5 Diagnostic Assessment Styles - Add these to your dashboard.html <style> section */

/* Diagnostic disclaimer banner */
.diagnostic-disclaimer {
  background: rgba(240, 164, 79, 0.1);
  border: 1px solid var(--warn);
  border-left: 3px solid var(--warn);
  border-radius: 8px;
  padding: 16px 20px;
  margin-bottom: 24px;
  font-size: 12px;
  color: var(--warn);
  display: flex;
  align-items: center;
  gap: 12px;
}

/* Primary diagnosis card */
.primary-diagnosis-card {
  background: var(--surface);
  border: 2px solid var(--accent3);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
}

.primary-diagnosis-card h3 {
  font-family: 'DM Serif Display', serif;
  font-size: 20px;
  margin-bottom: 12px;
  color: var(--accent3);
}

.confidence-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 500;
  margin-bottom: 12px;
}

.confidence-badge.high { 
  background: rgba(200,240,79,0.2); 
  color: var(--accent); 
  border: 1px solid var(--accent);
}
.confidence-badge.moderate { 
  background: rgba(240,164,79,0.2); 
  color: var(--warn); 
  border: 1px solid var(--warn);
}
.confidence-badge.low { 
  background: rgba(240,79,138,0.2); 
  color: var(--accent2); 
  border: 1px solid var(--accent2);
}
.confidence-badge.very.low { 
  background: rgba(107,114,128,0.2); 
  color: var(--muted); 
  border: 1px solid var(--muted);
}

.dsm-reference {
  margin-top: 16px;
  padding: 12px;
  background: var(--surface2);
  border-radius: 6px;
  font-size: 11px;
  color: var(--muted);
  border-left: 3px solid var(--accent3);
}

/* Criteria table */
.criteria-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 24px;
  background: var(--surface);
  border-radius: 8px;
  overflow: hidden;
}

.criteria-table th {
  background: var(--surface2);
  padding: 12px;
  text-align: left;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
}

.criteria-table td {
  padding: 16px 12px;
  border-bottom: 1px solid var(--border);
  vertical-align: top;
}

.criteria-table tr:last-child td {
  border-bottom: none;
}

.criteria-table tr.met {
  background: rgba(200,240,79,0.05);
}

.criteria-table tr.met td:first-child {
  border-left: 3px solid var(--accent);
}

.criteria-table tr.not-met {
  opacity: 0.5;
}

.criteria-table tr.not-met td:first-child {
  border-left: 3px solid transparent;
}

.evidence-item {
  background: var(--surface2);
  padding: 10px 12px;
  border-left: 3px solid var(--accent3);
  margin: 6px 0;
  border-radius: 4px;
}

.message-quote {
  font-style: italic;
  color: var(--text);
  margin-bottom: 6px;
  font-size: 12px;
}

.indicator-match {
  font-size: 10px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.status-icon {
  font-size: 18px;
  text-align: center;
}

/* All assessments summary */
.all-assessments {
  margin-top: 32px;
}

.assessment-summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-bottom: 8px;
  transition: border-color 0.2s;
}

.assessment-summary:hover {
  border-color: var(--accent3);
}

.assessment-summary .disorder-name {
  font-weight: 500;
  flex: 1;
}

.assessment-summary .criteria-count {
  color: var(--muted);
  font-size: 11px;
  margin: 0 16px;
}

.assessment-summary .percentage {
  font-family: 'DM Serif Display', serif;
  font-size: 16px;
  margin: 0 16px;
}

.no-diagnosis {
  text-align: center;
  padding: 40px;
  color: var(--muted);
  background: var(--surface);
  border-radius: 8px;
  border: 1px dashed var(--border);
}

</style>
</head>
<body>

<header>
  <div class="logo">Psycho<span>Graph</span></div>
  <div class="header-meta" id="headerMeta">Both Sides Analysis Â· Mental Health Insights</div>
</header>

<div class="app">
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Conversations</div>
      <div id="participantList">
        <div style="color: var(--muted); font-size: 11px; padding: 8px 0;">No data loaded</div>
      </div>
    </div>
  </aside>

  <main class="main" id="mainContent">
    <div class="upload-zone" id="uploadZone">
      <div class="upload-icon">ğŸ§ </div>
      <div class="upload-title">Upload Instagram Export</div>
      <div class="upload-sub">
        Upload a <strong>.json</strong> file (single conversation) or <strong>.zip</strong> file (full export)<br>
        The server will analyze both sides with Claude AI
      </div>
      <br>
      <input type="file" id="fileInput" accept=".json,.zip" style="display:none">
      <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Upload File</button>
    </div>

    <div id="analysisView" style="display:none"></div>
  </main>
</div>

<script>
// â”€â”€ API Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_URL = window.location.origin === "null" || window.location.origin === "file://"
  ? "http://127.0.0.1:8000/analyze"
  : "/analyze";

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentData = null;
let currentParticipant = null;

// â”€â”€ Show error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showUploadError(message) {
  const zone = document.getElementById('uploadZone');
  zone.innerHTML = `
    <div style="color:var(--accent2);font-size:14px;margin-bottom:12px">âš ï¸ Upload Error</div>
    <div style="color:var(--text);font-size:12px;line-height:1.7;white-space:pre-wrap;text-align:left;background:var(--surface2);padding:16px;border-radius:8px;border:1px solid var(--accent2);max-width:520px;margin:0 auto">${message}</div>
    <br>
    <button class="btn btn-demo" onclick="location.reload()" style="margin-top:8px">â† Try Again</button>
  `;
}

// â”€â”€ Upload and analyze â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function uploadAndAnalyze(file) {
  if (!file) return;

  const headerMeta = document.getElementById('headerMeta');
  const originalText = headerMeta.textContent;
  headerMeta.textContent = "Analyzing with Claude AI...";
  headerMeta.style.color = "var(--accent)";

  const uploadZone = document.getElementById('uploadZone');
  const originalZoneHTML = uploadZone.innerHTML;
  uploadZone.innerHTML = `
    <div class="loader" style="font-size:48px;margin-bottom:16px">ğŸ§ </div>
    <div style="font-family:'DM Serif Display',serif;font-size:18px;margin-bottom:8px">Analyzing both sides...</div>
    <div style="color:var(--muted);font-size:11px">This may take 30-60 seconds per conversation</div>
  `;

  try {
    const formData = new FormData();
    formData.append("file", file);

    const response = await fetch(API_URL, {
      method: "POST",
      body: formData
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.detail || `Server error: ${response.status}`);
    }

    const data = await response.json();
    loadData(data);

  } catch (err) {
    console.error("Analysis error:", err);
    let errorMessage = err.message || "Unknown error occurred";
    if (errorMessage.includes("Failed to fetch")) {
      errorMessage = "Cannot connect to the API server.\n\nMake sure server.py is running:\n  python3 server.py\n\nThen refresh this page.";
    }
    showUploadError(errorMessage);
    setTimeout(() => { uploadZone.innerHTML = originalZoneHTML; }, 100);
  } finally {
    headerMeta.textContent = originalText;
    headerMeta.style.color = "";
  }
}

// â”€â”€ File handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  await uploadAndAnalyze(file);
  e.target.value = '';
});

const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', async (e) => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');
  await uploadAndAnalyze(e.dataTransfer.files[0]);
});

// â”€â”€ Load data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadData(data) {
  currentData = data;
  document.getElementById('uploadZone').style.display = 'none';
  document.getElementById('analysisView').style.display = 'block';
  document.getElementById('headerMeta').textContent = `Patient: ${data.patient_name}`;

  buildSidebar(data);
  const firstParticipant = Object.keys(data.conversations)[0];
  if (firstParticipant) showParticipant(firstParticipant);
}

// â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSidebar(data) {
  const list = document.getElementById('participantList');
  list.innerHTML = '';
  for (const [name, conv] of Object.entries(data.conversations)) {
    const btn = document.createElement('button');
    btn.className = 'participant-btn';
    btn.innerHTML = `${name} <span class="msg-count">${conv.message_count || '?'}</span>`;
    btn.onclick = () => showParticipant(name);
    btn.id = `btn-${name}`;
    list.appendChild(btn);
  }
}

// â”€â”€ Show participant (BOTH SIDES VERSION) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showParticipant(name) {
  currentParticipant = name;
  document.querySelectorAll('.participant-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById(`btn-${name}`);
  if (btn) btn.classList.add('active');

  const conv = currentData.conversations[name];
  const view = document.getElementById('analysisView');

  if (conv.error) {
    view.innerHTML = `<div class="empty-state"><div class="big">Analysis Error</div><p>${conv.error}</p></div>`;
    return;
  }

  // Check if we have the new two-sided data
  const hasBothSides = conv._both_sides;
  
  let html = `<div class="fade-in">
    <div class="patient-header">
      <div class="patient-name">${currentData.patient_name} â†” ${name}</div>
      <div class="patient-sub">${conv.message_count} messages analyzed${hasBothSides ? ' Â· Both sides' : ''}</div>
    </div>`;

  if (conv.kpis && conv.kpis.flag_for_review) {
    html += `<div class="flag-banner">âš ï¸ ${conv.kpis.flag_reason}</div>`;
  }

  if (hasBothSides) {
    html += renderBothSides(conv, name);
  } else {
    html += renderOneSide(conv);
  }

  html += `</div>`;
  view.innerHTML = html;
}

// â”€â”€ Render BOTH SIDES version â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBothSides(conv, participantName) {
  const both = conv._both_sides;
  const kpis = both.kpis;
  const defense = both.defense;
  const summary = both.summary;

  let html = '';

  // Relationship health score
  if (kpis.relationship_health_score !== undefined) {
    const score = kpis.relationship_health_score;
    const scoreColor = score >= 7 ? 'var(--accent)' : score >= 4 ? 'var(--warn)' : 'var(--accent2)';
    const scoreLabel = score >= 7 ? 'Healthy Dynamic' : score >= 4 ? 'Moderate Concerns' : 'Significant Concerns';
    
    html += `<div class="health-score-card">
      <div class="health-circle" style="border-color:${scoreColor};color:${scoreColor}">${score}/10</div>
      <div class="health-info">
        <h3>${scoreLabel}</h3>
        <p>Overall relationship health score based on bidirectional analysis.</p>
      </div>
    </div>`;
  }

  // Dynamic analysis
  if (kpis.dynamic_analysis) {
    html += `<div class="interaction-box">
      <h4>Interaction Dynamic</h4>
      <p>${kpis.dynamic_analysis}</p>
    </div>`;
  }

  // TWO COLUMN KPIs
  html += `<div class="section-title">Communication KPIs - Both Sides</div>`;
  html += `<div class="two-column">`;
  
  // Patient column
  html += `<div>
    <div class="column-header patient">${currentData.patient_name}</div>
    <div class="kpi-grid">`;
  for (const [key, val] of Object.entries(kpis.patient_kpis || {})) {
    const s = val.score;
    const c = s >= 7 ? '#c8f04f' : s >= 4 ? '#f0a44f' : '#f04f8a';
    html += `<div class="kpi-card">
      <div class="kpi-name">${key.replace(/_/g,' ')}</div>
      <div class="kpi-score" style="color:${c}">${s}</div>
      <div class="kpi-bar"><div class="kpi-fill" style="width:${s*10}%;background:${c}"></div></div>
      <div class="kpi-rationale">${val.rationale}</div>
    </div>`;
  }
  html += `</div></div>`;

  // Other person column
  html += `<div>
    <div class="column-header other">${participantName}</div>
    <div class="kpi-grid">`;
  for (const [key, val] of Object.entries(kpis.other_kpis || {})) {
    const s = val.score;
    const c = s >= 7 ? '#c8f04f' : s >= 4 ? '#f0a44f' : '#f04f8a';
    html += `<div class="kpi-card">
      <div class="kpi-name">${key.replace(/_/g,' ')}</div>
      <div class="kpi-score" style="color:${c}">${s}</div>
      <div class="kpi-bar"><div class="kpi-fill" style="width:${s*10}%;background:${c}"></div></div>
      <div class="kpi-rationale">${val.rationale}</div>
    </div>`;
  }
  html += `</div></div>`;
  html += `</div>`; // close two-column

  // TWO COLUMN Defense Mechanisms
  html += `<div class="section-title">Defense Mechanisms - Both Sides</div>`;
  if (defense.interaction_pattern) {
    html += `<div class="interaction-box">
      <h4>Interaction Pattern</h4>
      <p>${defense.interaction_pattern}</p>
    </div>`;
  }
  
  html += `<div class="two-column">`;
  
  // Patient defense
  html += `<div>
    <div class="column-header patient">${currentData.patient_name}</div>`;
  if (defense.patient_dominant && defense.patient_dominant !== 'none') {
    html += `<div style="margin-bottom:12px">Dominant: <span class="dominant-tag" style="background:rgba(200,240,79,0.15);border-color:var(--accent);color:var(--accent)">${defense.patient_dominant}</span> &nbsp; Total: <strong>${defense.patient_total || 0}</strong></div>`;
  }
  html += `<div class="defense-grid">`;
  for (const [key, val] of Object.entries(defense.patient_defense_mechanisms || {})) {
    const active = val.count > 0 ? 'active' : '';
    html += `<div class="defense-card ${active}">
      <div class="defense-count">${val.count}</div>
      <div class="defense-info">
        <div class="defense-name">${key.replace(/_/g,' ')}</div>
        ${val.example ? `<div class="defense-example">"${val.example}"</div>` : ''}
      </div>
    </div>`;
  }
  html += `</div></div>`;

  // Other person defense
  html += `<div>
    <div class="column-header other">${participantName}</div>`;
  if (defense.other_dominant && defense.other_dominant !== 'none') {
    html += `<div style="margin-bottom:12px">Dominant: <span class="dominant-tag" style="background:rgba(79,200,240,0.15);border-color:var(--accent3);color:var(--accent3)">${defense.other_dominant}</span> &nbsp; Total: <strong>${defense.other_total || 0}</strong></div>`;
  }
  html += `<div class="defense-grid">`;
  for (const [key, val] of Object.entries(defense.other_defense_mechanisms || {})) {
    const active = val.count > 0 ? 'active' : '';
    html += `<div class="defense-card ${active}">
      <div class="defense-count">${val.count}</div>
      <div class="defense-info">
        <div class="defense-name">${key.replace(/_/g,' ')}</div>
        ${val.example ? `<div class="defense-example">"${val.example}"</div>` : ''}
      </div>
    </div>`;
  }
  html += `</div></div>`;
  html += `</div>`; // close two-column

  // Qualitative Summary
  html += `<div class="section-title">Qualitative Summary</div>`;
  if (summary.relationship_dynamic) {
    html += `<div class="dynamic-pill">ğŸ”— ${summary.relationship_dynamic}</div>`;
  }
  if (summary.clinical_notes) {
    html += `<div class="clinical-notes">${summary.clinical_notes}</div>`;
  }

  // TWO COLUMN Patterns/Flags/Strengths
  html += `<div class="two-column">`;
  
  // Patient column
  html += `<div>
    <div class="column-header patient">${currentData.patient_name}</div>`;
  if (summary.patient_patterns && summary.patient_patterns.length > 0) {
    html += `<h4 style="font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin:16px 0 8px">Patterns</h4>`;
    html += `<div class="tag-list">${summary.patient_patterns.map(p => `<span class="tag tag-blue">${p}</span>`).join('')}</div>`;
  }
  if (summary.patient_red_flags && summary.patient_red_flags.length > 0) {
    html += `<h4 style="font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin:16px 0 8px">Red Flags</h4>`;
    html += `<div class="tag-list">${summary.patient_red_flags.map(r => `<span class="tag tag-red">${r}</span>`).join('')}</div>`;
  }
  if (summary.patient_strengths && summary.patient_strengths.length > 0) {
    html += `<h4 style="font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin:16px 0 8px">Strengths</h4>`;
    html += `<div class="tag-list">${summary.patient_strengths.map(s => `<span class="tag tag-green">${s}</span>`).join('')}</div>`;
  }
  html += `</div>`;

  // Other person column
  html += `<div>
    <div class="column-header other">${participantName}</div>`;
  if (summary.other_patterns && summary.other_patterns.length > 0) {
    html += `<h4 style="font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin:16px 0 8px">Patterns</h4>`;
    html += `<div class="tag-list">${summary.other_patterns.map(p => `<span class="tag tag-blue">${p}</span>`).join('')}</div>`;
  }
  if (summary.other_red_flags && summary.other_red_flags.length > 0) {
    html += `<h4 style="font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin:16px 0 8px">Red Flags</h4>`;
    html += `<div class="tag-list">${summary.other_red_flags.map(r => `<span class="tag tag-red">${r}</span>`).join('')}</div>`;
  }
  if (summary.other_strengths && summary.other_strengths.length > 0) {
    html += `<h4 style="font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin:16px 0 8px">Strengths</h4>`;
    html += `<div class="tag-list">${summary.other_strengths.map(s => `<span class="tag tag-green">${s}</span>`).join('')}</div>`;
  }
  html += `</div>`;
  html += `</div>`; // close two-column

  // Therapy suggestions (shared)
  if (summary.therapy_suggestions && summary.therapy_suggestions.length > 0) {
    html += `<h4 style="font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin:24px 0 12px">Therapy Suggestions</h4>`;
    html += `<div class="tag-list">${summary.therapy_suggestions.map(t => `<span class="tag tag-warn">${t}</span>`).join('')}</div>`;
  }

  html += renderDSM5Diagnosis(conv);
  return html;
}

// â”€â”€ Render ONE SIDE version (fallback) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOneSide(conv) {
  let html = '<div class="empty-state"><div class="big">Old Format Detected</div><p>This analysis was done with the old one-sided analyzer. Re-upload to get both sides analysis.</p></div>';
  return html;
}

// DSM-5 Rendering Function - Add this to your dashboard.html JavaScript section

function renderDSM5Diagnosis(conv) {
  if (!conv.dsm5_diagnosis) return '';
  
  const dsm5 = conv.dsm5_diagnosis;
  let html = '<div class="section-title" style="margin-top:48px">DSM-5 Diagnostic Assessment</div>';
  
  // Disclaimer banner
  html += `<div class="diagnostic-disclaimer">
    <span style="font-size:18px">âš ï¸</span>
    <div>${dsm5.disclaimer}</div>
  </div>`;
  
  // Primary Diagnosis Card
  if (dsm5.primary_diagnosis && dsm5.primary_diagnosis.meets_diagnostic_threshold) {
    const pd = dsm5.primary_diagnosis;
    html += `<div class="primary-diagnosis-card">
      <h3>Primary Indication: ${pd.disorder_name}</h3>
      <div class="confidence-badge ${pd.confidence_level.toLowerCase().replace(' ', '.')}">${pd.confidence_level} Confidence</div>
      <p style="line-height:1.6;margin-bottom:12px">${pd.clinical_interpretation}</p>
      <div class="dsm-reference">
        ğŸ“– <strong>DSM-5 Reference:</strong> Page ${pd.dsm5_page} (PDF page ${pd.pdf_page})<br>
        <strong>Section:</strong> ${pd.section}<br>
        <strong>Criteria Met:</strong> ${pd.criteria_met}/${pd.total_criteria} required (${pd.criteria_met_percentage}%)
        ${pd.duration_note !== 'Not specified' ? `<br><strong>Duration:</strong> ${pd.duration_note}` : ''}
      </div>
    </div>`;
    
    // Criteria Breakdown Table
    html += `<h4 style="font-size:14px;margin-bottom:16px;color:var(--accent3)">Diagnostic Criteria Breakdown</h4>`;
    html += `<table class="criteria-table">
      <thead>
        <tr>
          <th style="width:50%">Criterion</th>
          <th style="width:60px;text-align:center">Status</th>
          <th>Evidence from Conversation</th>
        </tr>
      </thead>
      <tbody>`;
    
    for (const [id, criterion] of Object.entries(pd.criteria_breakdown)) {
      const status = criterion.is_met ? 'âœ“' : 'âœ—';
      const statusColor = criterion.is_met ? 'var(--accent)' : 'var(--muted)';
      const rowClass = criterion.is_met ? 'met' : 'not-met';
      
      html += `<tr class="${rowClass}">
        <td>
          <div style="font-weight:500;margin-bottom:4px;font-size:11px;color:var(--accent3)">${id}</div>
          <div style="line-height:1.5">${criterion.criterion_text}</div>
        </td>
        <td class="status-icon" style="color:${statusColor}">${status}</td>
        <td>`;
      
      if (criterion.evidence && criterion.evidence.length > 0) {
        for (const ev of criterion.evidence) {
          html += `<div class="evidence-item">
            <div class="message-quote">"${ev.message}"</div>
            <div class="indicator-match">Matches indicator: ${ev.indicator_matched}</div>
          </div>`;
        }
        if (criterion.evidence_count > criterion.evidence.length) {
          html += `<div style="color:var(--muted);font-size:11px;margin-top:8px">
            +${criterion.evidence_count - criterion.evidence.length} more occurrence(s)
          </div>`;
        }
      } else {
        html += '<span style="color:var(--muted);font-size:11px">No evidence found in conversation</span>';
      }
      
      html += '</td></tr>';
    }
    
    html += '</tbody></table>';
  } else {
    // No primary diagnosis - show summary
    html += `<div class="no-diagnosis">
      <div style="font-size:18px;margin-bottom:8px">No Diagnostic Criteria Met</div>
      <p>Based on the conversation analyzed, no disorders met the diagnostic threshold.</p>
      <p style="margin-top:8px;font-size:11px">This does not rule out mental health concerns. Clinical evaluation recommended if symptoms are present.</p>
    </div>`;
  }
  
  // All Assessments Summary
  if (dsm5.all_assessments && dsm5.all_assessments.length > 0) {
    html += '<h4 style="font-size:14px;margin-top:32px;margin-bottom:16px;color:var(--muted)">All Disorders Assessed:</h4>';
    html += '<div class="all-assessments">';
    
    for (const assessment of dsm5.all_assessments) {
      const badgeClass = assessment.confidence_level.toLowerCase().replace(' ', '.');
      html += `<div class="assessment-summary">
        <span class="disorder-name">${assessment.disorder_name}</span>
        <span class="criteria-count">${assessment.criteria_met}/${assessment.total_criteria} criteria</span>
        <span class="percentage">${assessment.criteria_met_percentage}%</span>
        <span class="confidence-badge ${badgeClass}">${assessment.confidence_level}</span>
      </div>`;
    }
    
    html += '</div>';
  }
  
  return html;
}

// IMPORTANT: Add this call to the renderBothSides function
// Find the line that says: return html;
// RIGHT BEFORE that line, add:
// html += renderDSM5Diagnosis(conv);

</script>
</body>
</html>
